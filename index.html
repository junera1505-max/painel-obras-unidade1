<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extrator Universal Project XML</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        .drag-area { border: 2px dashed #cbd5e1; transition: all 0.3s ease; }
        .drag-area.active { border-color: #3b82f6; background-color: #eff6ff; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans p-8">

    <div class="max-w-6xl mx-auto bg-white p-8 rounded-lg shadow-xl">
        <div class="border-b pb-4 mb-6">
            <h1 class="text-2xl font-bold text-slate-800">Extrator Universal de EAP</h1>
            <p class="text-gray-500 text-sm mt-1">Compatível com múltiplos contratos e formatos.</p>
        </div>

        <div id="step-1" class="mb-8">
            <h2 class="text-lg font-bold text-blue-900 mb-2">1. Carregar Arquivo</h2>
            <div id="drop-zone" class="drag-area p-10 rounded-xl text-center cursor-pointer bg-slate-50 hover:bg-blue-50">
                <p class="text-lg font-semibold text-slate-700">Arraste seu XML aqui ou clique</p>
                <input type="file" id="file-input" accept=".xml" class="hidden">
            </div>
        </div>

        <div id="step-2" class="hidden mb-8 bg-yellow-50 border border-yellow-200 p-6 rounded-lg">
            <h2 class="text-lg font-bold text-yellow-800 mb-2">2. Identificação da Coluna "Economias"</h2>
            <p class="text-sm text-gray-700 mb-4">O Project permite criar campos com qualquer nome. Selecione abaixo qual campo corresponde às economias neste arquivo:</p>
            
            <div class="flex gap-4 items-end">
                <div class="flex-1">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Campos encontrados no arquivo:</label>
                    <select id="field-selector" class="w-full p-2 border border-gray-300 rounded bg-white font-mono text-sm">
                        <option value="">Carregando campos...</option>
                    </select>
                </div>
                <button id="process-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded shadow transition">
                    Confirmar e Processar
                </button>
            </div>
        </div>

        <div id="step-3" class="hidden">
            <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-6 flex justify-between items-center">
                <div>
                    <p class="font-bold text-green-900" id="result-title">Sucesso</p>
                    <p class="text-sm text-green-700" id="process-info">Dados extraídos.</p>
                </div>
                <button id="download-btn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-6 rounded shadow flex items-center">
                    Baixar Excel
                </button>
            </div>

            <div class="overflow-x-auto border rounded-lg shadow-sm max-h-96 overflow-y-auto">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead class="bg-slate-800 text-white sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left">NOME OBRA</th>
                            <th class="px-4 py-3 text-left">Início Lib.</th>
                            <th class="px-4 py-3 text-left">Término Lib.</th>
                            <th class="px-4 py-3 text-left">Início Obra</th>
                            <th class="px-4 py-3 text-left">Término Obra</th>
                            <th class="px-4 py-3 text-left bg-yellow-600 text-white">Economias (Selecionado)</th>
                        </tr>
                    </thead>
                    <tbody id="preview-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            targetLevel: 4, 
            childKeywords: { liberacao: "Liberações", obra: "Obra" }
        };

        let xmlDocGlobal = null;
        let finalData = [];
        let fileNameGlobal = "";

        // UI References
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const fieldSelector = document.getElementById('field-selector');
        const processBtn = document.getElementById('process-btn');
        const downloadBtn = document.getElementById('download-btn');
        
        const step2 = document.getElementById('step-2');
        const step3 = document.getElementById('step-3');

        // Listeners
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFile);
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('active'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('active'));
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('active'); if(e.dataTransfer.files.length) handleFile({target: {files: e.dataTransfer.files}}); });
        
        processBtn.addEventListener('click', runExtraction);
        downloadBtn.addEventListener('click', exportExcel);

        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            fileNameGlobal = file.name;

            const reader = new FileReader();
            reader.onload = (evt) => {
                const parser = new DOMParser();
                xmlDocGlobal = parser.parseFromString(evt.target.result, "text/xml");
                populateFieldSelector(xmlDocGlobal);
            };
            reader.readAsText(file);
        }

        // --- Passo 2: Popular Dropdown com Metadados ---
        function populateFieldSelector(xmlDoc) {
            const definitions = xmlDoc.getElementsByTagName("ExtendedAttribute");
            fieldSelector.innerHTML = "";
            let foundSmartDefault = false;

            // Cria uma opção "Vazia" caso o usuário não queira economias
            const defaultOption = document.createElement("option");
            defaultOption.value = "";
            defaultOption.text = "-- Selecione o campo de Economias --";
            fieldSelector.appendChild(defaultOption);

            // Mapeia todos os campos definidos no arquivo
            // Filtrar apenas definições (que tem FieldID e (Alias ou FieldName))
            // No XML Project, as definições ficam no topo.
            // Precisamos filtrar duplicatas pois ExtendedAttribute aparece nas Tasks também
            const uniqueFields = new Map();

            for (let i = 0; i < definitions.length; i++) {
                const def = definitions[i];
                // Verifica se é uma definição (geralmente tem Alias, ou é pai direto de Project)
                // Uma heurística melhor: Definições não têm "Value"
                if (def.getElementsByTagName("Value").length > 0) continue; 

                const fid = getNodeVal(def, "FieldID");
                const alias = getNodeVal(def, "Alias");
                const fieldName = getNodeVal(def, "FieldName");

                if (fid && !uniqueFields.has(fid)) {
                    let displayName = alias ? `${alias} (${fieldName})` : fieldName;
                    if (!displayName) displayName = `Campo Customizado ID ${fid}`;
                    
                    uniqueFields.set(fid, displayName);

                    const option = document.createElement("option");
                    option.value = fid;
                    option.text = displayName;
                    
                    // Lógica de Seleção Inteligente
                    if (!foundSmartDefault) {
                        const lowerName = displayName.toLowerCase();
                        if (lowerName.includes("econo") || lowerName.includes("prevista") || fieldName === "Text16") {
                            option.selected = true;
                            foundSmartDefault = true;
                        }
                    }
                    fieldSelector.appendChild(option);
                }
            }

            if (uniqueFields.size === 0) {
                const opt = document.createElement("option");
                opt.text = "Nenhum campo customizado encontrado no arquivo.";
                fieldSelector.appendChild(opt);
            }

            // Mostra o passo 2
            step2.classList.remove("hidden");
        }

        // --- Passo 3: Processar com o ID escolhido ---
        function runExtraction() {
            if (!xmlDocGlobal) return;
            
            const selectedID = fieldSelector.value;
            const tasks = Array.from(xmlDocGlobal.getElementsByTagName("Task"));
            finalData = [];

            for (let i = 0; i < tasks.length; i++) {
                const task = tasks[i];
                const level = parseInt(getNodeVal(task, "OutlineLevel") || 0);

                if (level === CONFIG.targetLevel) {
                    const rowData = {
                        nomeObra: getNodeVal(task, "Name"),
                        inicioLib: null,
                        fimLib: null,
                        inicioObra: null,
                        fimObra: null,
                        economias: selectedID ? getCustomFieldVal(task, selectedID) : "-"
                    };

                    // Look-ahead
                    for (let j = i + 1; j < tasks.length; j++) {
                        const subTask = tasks[j];
                        const subLevel = parseInt(getNodeVal(subTask, "OutlineLevel") || 0);
                        if (subLevel <= CONFIG.targetLevel) break;

                        if (subLevel === CONFIG.targetLevel + 1) {
                            const subName = getNodeVal(subTask, "Name");
                            if (subName.includes(CONFIG.childKeywords.liberacao)) {
                                rowData.inicioLib = parseDate(getNodeVal(subTask, "Start"));
                                rowData.fimLib = parseDate(getNodeVal(subTask, "Finish"));
                            } else if (subName.includes(CONFIG.childKeywords.obra)) {
                                rowData.inicioObra = parseDate(getNodeVal(subTask, "Start"));
                                rowData.fimObra = parseDate(getNodeVal(subTask, "Finish"));
                            }
                        }
                    }

                    if (rowData.nomeObra) finalData.push(rowData);
                }
            }
            renderUI();
        }

        // --- Helpers ---
        function getCustomFieldVal(task, targetID) {
            const exts = task.getElementsByTagName("ExtendedAttribute");
            for (let k = 0; k < exts.length; k++) {
                if (getNodeVal(exts[k], "FieldID") === targetID) {
                    const val = getNodeVal(exts[k], "Value");
                    return isNaN(parseFloat(val)) ? val : parseFloat(val);
                }
            }
            return "";
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            const d = new Date(dateStr);
            return isNaN(d) ? null : d;
        }

        function formatDisplayDate(dateObj) {
            if (!dateObj) return "";
            return dateObj.toLocaleDateString('pt-BR');
        }

        function getNodeVal(parent, tagName) {
            const node = parent.getElementsByTagName(tagName)[0];
            return node ? node.textContent : "";
        }

        function renderUI() {
            document.getElementById('process-info').innerText = `${finalData.length} obras processadas com sucesso.`;
            step3.classList.remove('hidden');

            const tbody = document.getElementById('preview-body');
            tbody.innerHTML = "";
            
            finalData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-4 py-2 font-medium border-b">${row.nomeObra}</td>
                    <td class="px-4 py-2 text-gray-500 border-b">${formatDisplayDate(row.inicioLib)}</td>
                    <td class="px-4 py-2 text-gray-500 border-b">${formatDisplayDate(row.fimLib)}</td>
                    <td class="px-4 py-2 text-blue-600 border-b">${formatDisplayDate(row.inicioObra)}</td>
                    <td class="px-4 py-2 text-blue-600 border-b">${formatDisplayDate(row.fimObra)}</td>
                    <td class="px-4 py-2 font-bold bg-yellow-50 border-b text-center">${row.economias}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function exportExcel() {
            const exportData = finalData.map(d => ({
                "NOME OBRA": d.nomeObra,
                "Início Liberação": d.inicioLib,
                "Término Liberações": d.fimLib,
                "Início Obras": d.inicioObra,
                "Término Obras": d.fimObra,
                "Qtd. Econo. Previstas": d.economias
            }));

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(exportData);
            ws['!cols'] = [{wch: 50}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 20}];

            const range = XLSX.utils.decode_range(ws['!ref']);
            for(let R = range.s.r; R <= range.e.r; ++R) {
                for(let C = range.s.c; C <= range.e.c; ++C) {
                    const cell_ref = XLSX.utils.encode_cell({c:C, r:R});
                    if (R > 0 && C >= 1 && C <= 4 && ws[cell_ref]) {
                        ws[cell_ref].z = 'dd/mm/yyyy';
                    }
                }
            }

            XLSX.utils.book_append_sheet(wb, ws, "Controle Obras");
            XLSX.writeFile(wb, "Relatorio_Obras_" + fileNameGlobal.replace('.xml','.xlsx'));
        }
    </script>
</body>
</html>
