<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Acompanhamento - v23 (Coordena√ß√£o e Cards R$)</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        /* CSS completo */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        body, html { margin: 0; padding: 0; font-family: 'Poppins', sans-serif; color: #333; height: 100%; overflow: hidden; background-color: #f4f7fa; }
        * { box-sizing: border-box; }
        .system-container { display: flex; height: 100vh; transition: all 0.3s ease-in-out; }
        .sidebar { width: 280px; background-color: rgba(30, 58, 95, 0.85); color: white; padding: 20px; display: flex; flex-direction: column; flex-shrink: 0; border-right: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 2px 0 10px rgba(0,0,0,0.1); transition: width 0.3s ease-in-out, opacity 0.3s ease-in-out; overflow-y: auto; }
        .sidebar.hidden { width: 0; opacity: 0; padding: 0; pointer-events: none; }
        .sidebar-header .company-logo { position: static; width: 80%; margin: 0 auto 30px auto; display: block; }
        #main-nav { flex-grow: 1; overflow-y: auto; margin-bottom: 20px; }
        #main-nav ul { list-style-type: none; padding: 0; margin: 0; }
        #main-nav li a { display: block; padding: 15px 20px; color: #e0e0e0; text-decoration: none; border-radius: 8px; margin-bottom: 5px; font-weight: 500; transition: all 0.2s ease; cursor: pointer; position: relative; background-color: transparent; }
        #main-nav li a:hover { background-color: rgba(255, 255, 255, 0.1); color: white; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        #main-nav li a.active { background-color: #ffffff; color: #1e3a5f; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transform: translateY(-2px); }
        .content-area { flex-grow: 1; padding: 40px; overflow-y: auto; background-color: #f4f7fa; transition: padding-left 0.3s ease-in-out; position: relative; }
        
        .content-area.fullscreen { padding: 0; overflow: hidden; display: flex; justify-content: center; align-items: center; background-color: #eef2f6; }
        
        .content-header { margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;}
        .content-header h1 { font-size: 2.2rem; color: #1e3a5f; margin: 0; }
        .content-header p { font-size: 1.1rem; color: #5a718c; margin: 0; }
        .btn-primary { background-color: #007bff; color: white; padding: 10px 20px; border-radius: 6px; border: none; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #0069d9; }
        .btn-secondary { background-color: #6c757d; color: white; padding: 10px 20px; border-radius: 6px; border: none; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .btn-secondary:hover { background-color: #5a6268; }
        .sidebar-footer { margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2); flex-shrink: 0; }
        #btn-adicionar-contrato { width: 100%; padding: 15px; background-color: #4caf50; color: white; border: none; border-radius: 8px; font-family: 'Poppins', sans-serif; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s ease; }
        #btn-adicionar-contrato:hover { background-color: #45a049; }
        .danger-zone { margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0; }
        .danger-zone h3 { color: #c82333; }
        #btn-excluir-contrato { background-color: #c82333; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background-color 0.2s ease; }
        #btn-excluir-contrato:hover { background-color: #a51c29; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background-color: #fff; width: 90%; max-width: 700px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: flex; flex-direction: column; max-height: 90vh; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 25px; border-bottom: 1px solid #e5e5e5; }
        .modal-header h2 { margin: 0; color: #1e3a5f; }
        .close-button { border: none; background: none; font-size: 2.5rem; cursor: pointer; color: #aaa; line-height: 1; padding: 0; }
        .close-button:hover { color: #333; }
        .modal-body { padding: 25px; overflow-y: auto; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; font-size: 1rem; border: 1px solid #ccc; border-radius: 6px; font-family: 'Poppins', sans-serif; }
        .form-group input:read-only, .form-group textarea:read-only, input:read-only { background-color: #e9ecef; opacity: 1; cursor: not-allowed; }
        textarea { resize: vertical; min-height: 80px; }
        fieldset { border: 1px solid #ccc; border-radius: 6px; padding: 15px; margin-top: 20px; grid-column: 1 / -1; }
        legend { font-weight: 600; color: #1e3a5f; padding: 0 10px; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; padding: 15px 25px; border-top: 1px solid #e5e5e5; background-color: #f9f9f9; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; }
        .cs-controls { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); flex-wrap: wrap; }
        .cs-controls input, .cs-controls select { padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; }
        .cs-table-wrapper { overflow-x: auto; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .cs-table { width: 100%; border-collapse: collapse; min-width: 800px; }
        .cs-table th, .cs-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        .cs-table th { font-weight: 600; color: #1e3a5f; background-color: #f8faff; white-space: nowrap; }
        .cs-table tr:last-child td { border-bottom: none; }
        .cs-table tr:hover { background-color: #f4f7fa; }
        .status-badge { padding: 4px 8px; border-radius: 12px; color: white; font-weight: 600; font-size: 0.8rem; text-align: center; }
        .status-badge.pendente { background-color: #ffc107; color: #333; }
        .status-badge.respondido { background-color: #28a745; }
        .status-badge.atrasado { background-color: #dc3545; }
        .prazo-atencao { color: #ff9800; font-weight: 700; }
        .prazo-vencido { color: #dc3545; font-weight: 700; }
        .actions-cell { display: flex; gap: 10px; }
        .actions-cell button { background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: 5px; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 30px; }
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; text-align: center; }
        .metric-card { background-color: #ffffff; padding: 20px; border-radius: 12px; border: 1px solid #dbe3f0; box-shadow: 0 4px 12px rgba(0,20,60,0.05); }
        .metric-card .label { font-size: 0.9rem; color: #5a718c; margin-bottom: 8px; }
        .metric-card .value { font-size: 2.2rem; font-weight: 700; color: #007bff; }
        .metric-card .value.goal { color: #28a745; }
        .progress-card { text-align: left; }
        .input-area { display: flex; align-items: center; gap: 5px; margin-bottom: 10px; }
        .progress-card label { font-weight: 600; color: #1e3a5f; white-space: nowrap; margin-right: 10px;}
        .input-wrapper { position: relative; flex-grow: 1; }
        .input-wrapper .currency-symbol { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 1rem; color: #5a718c; font-weight: 600; }
        .progress-card input { width: 100%; padding: 10px 10px 10px 35px; font-size: 1rem; font-family: 'Poppins', sans-serif; border: 2px solid #cdd7e5; border-radius: 8px; outline: none; transition: all 0.2s; }
        input.no-symbol { padding: 10px 15px !important; }
        input:focus { border-color: #007bff; box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2); }
        .progress-bar-container { background-color: #e9ecef; border-radius: 8px; height: 25px; margin-bottom: 15px; overflow: hidden; }
        .progress-bar-fill { background-color: #28a745; height: 100%; width: 0%; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.9rem; transition: width 0.5s ease-in-out; }
        .progress-details { display: flex; justify-content: space-between; font-size: 0.9rem; color: #5a718c; flex-wrap: wrap; gap: 10px; }
        .progress-details span { font-weight: 600; color: #333; }
        .goal-surpassed { color: #28a745; font-weight: 700; }
        .progress-bar-sewage { height: 35px; border-radius: 17px; background-color: #e9ecef; margin-bottom: 15px; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: flex-start; }
        .progress-bar-sewage::before { content: 'üè†'; font-size: 1.8rem; position: absolute; left: 5px; top: 50%; transform: translateY(-50%); z-index: 2; }
        .progress-bar-sewage::after { content: 'üè≠'; font-size: 1.8rem; position: absolute; right: 5px; top: 50%; transform: translateY(-50%); z-index: 2; }
        .progress-bar-fill-sewage { height: 100%; background-color: #007bff; border-radius: 17px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.9rem; transition: width 0.5s ease-in-out; }
        .slideshow-wrapper { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: flex-start; align-items: stretch; position: relative; }
        .content-area.fullscreen .slideshow-wrapper { justify-content: center; }
        .slideshow-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; margin-bottom: 20px; border-bottom: 1px solid #e0e0e0; }
        .content-area.fullscreen .slideshow-header { display: none; }
        .slideshow-header h1 { margin: 0; font-size: 2.2rem; color: #1e3a5f; }
        .fullscreen-button { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: #5a718c; padding: 0; line-height: 1; transition: color 0.2s ease; }
        .fullscreen-button:hover { color: #1e3a5f; }
        .exit-fullscreen-button { display: none; position: absolute; top: 20px; right: 20px; background-color: rgba(0,0,0,0.6); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; z-index: 1001; font-size: 1rem; }
        .content-area.fullscreen .exit-fullscreen-button { display: block; }
        
        .slideshow-content { flex-grow: 1; display: grid; position: relative; max-width: 1200px; width: 100%; margin: 0 auto; }
        .content-area.fullscreen .slideshow-content { height: 100vh; max-height: 100vh; display: grid; padding: 20px 0; align-items: center; }
        .panel-slide { grid-column-start: 1; grid-row-start: 1; opacity: 0; visibility: hidden; transition: opacity 0.7s ease-in-out, visibility 0.7s; background-color: white; border-radius: 12px; padding: 30px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 25px; width: 100%; }
        .content-area.fullscreen .panel-slide { height: 100%; max-height: 95vh; display: flex; flex-direction: column; box-shadow: none; overflow: hidden; }
        .panel-slide.active { opacity: 1; visibility: visible; }
        .panel-slide h2 { font-size: 2rem; color: #1e3a5f; margin: 0 0 20px 0; text-align: center; }
        .panel-slide .progress-bar-container { height: 40px; border-radius: 20px; margin-bottom: 20px; flex-shrink: 0; }
        .panel-slide .progress-bar-fill, .panel-slide .progress-bar-fill-sewage { border-radius: 20px; font-size: 1.1rem; font-weight: 700; }
        .panel-slide .progress-details { font-size: 1.1rem; font-weight: 500; color: #5a718c; display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; flex-shrink: 0; }
        .panel-slide .progress-details div { padding: 10px 0; border-radius: 8px; background-color: #f8fafd; text-align: center; box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); }
        .panel-slide .progress-details span { font-weight: 700; color: #1e3a5f; display: block; font-size: 1.4rem; }
        .panel-slide .progress-details div .goal-surpassed { color: #28a745 !important; }
        .panel-slide .progress-details div:first-child span { color: #c82333; }
        .panel-slide .progress-details div:nth-child(2) span { color: #007bff; }
        .panel-slide .progress-details div:nth-child(3) span { color: #28a745; }
        .panel-slide .progress-details div:nth-child(4) span { color: #6f42c1; }
        .calendars { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 20px; padding: 10px; background: #f8fafd; border-radius: 8px;}
        #calendars-avance { max-height: 400px; overflow-y: auto; }
        .content-area.fullscreen .calendars { flex-grow: 1; max-height: none !important; overflow-y: auto; padding-bottom: 50px; }
        .month { background-color: #fff; border-radius: 10px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .month h3 { text-align: center; font-size: 1.3rem; color: #1e3a5f; margin-bottom: 15px; }
        .calendar-grid { display: grid; grid-template-columns: 30px repeat(7, 1fr); gap: 5px; }
        .day-name { font-weight: 600; color: #5a718c; font-size: 0.85rem; text-align: center; padding: 8px 0; }
        .week-number-header { grid-column: 1; }
        .week-number { display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 600; color: #6f42c1; background-color: #f4f1fa; border-radius: 6px; }
        .day { border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 45px; position: relative; }
        .day-of-month { font-size: 0.7rem; color: #6c757d; }
        .day.weekend { background-color: #f1f3f5; }
        .day.past-day { background-color: #e9ecef; color: #ced4da; text-decoration: line-through; font-weight: 600; }
        .day.today { background-color: #fff3cd; border: 2px solid #ffeeba; }
        .day.end-date { background-color: #007bff; color: white; }
        .day.end-date::after { content: 'üéØ'; position: absolute; top: -5px; right: -5px; font-size: 1rem; }
        .empty-day { visibility: hidden; }
        .day.future-workday { background-color: #eaf6ff; }
        .day.holiday { background-color: #fdeaea; }
        
        .sidebar-toggle { display: none; position: fixed; top: 15px; left: 15px; z-index: 999; width: 40px; height: 40px; background: #1e3a5f; border: none; border-radius: 8px; padding: 8px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); flex-direction: column; justify-content: space-around; }
        .sidebar-toggle span { display: block; width: 100%; height: 3px; background: white; border-radius: 2px; transition: all 0.3s; }
        .sidebar.is-open + .sidebar-toggle span:nth-child(1) { transform: translateY(7px) rotate(45deg); }
        .sidebar.is-open + .sidebar-toggle span:nth-child(2) { opacity: 0; }
        .sidebar.is-open + .sidebar-toggle span:nth-child(3) { transform: translateY(-7px) rotate(-45deg); }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 997; }
        .sidebar-overlay.is-open { display: block; }

        /* --- PLANEJAMENTO 2026 --- */
        .planning-tabs { display: flex; gap: 5px; overflow-x: auto; border-bottom: 2px solid #e0e0e0; margin-bottom: 20px; padding-bottom: 5px; }
        .planning-tab-btn { background: none; border: none; padding: 10px 20px; font-family: 'Poppins', sans-serif; font-size: 0.95rem; color: #5a718c; cursor: pointer; border-radius: 6px 6px 0 0; transition: all 0.2s; white-space: nowrap; }
        .planning-tab-btn:hover { background-color: #f0f4f8; color: #1e3a5f; }
        .planning-tab-btn.active { background-color: #1e3a5f; color: white; font-weight: 600; }
        .planning-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-top: 20px; }
        .planning-month-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #eee; text-align: center; cursor: pointer; transition: all 0.2s; position: relative; }
        .planning-month-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-color: #007bff; }
        .planning-month-card.active-month { border: 2px solid #007bff; background-color: #f0f7ff; }
        .planning-month-card h4 { margin: 0 0 10px 0; color: #1e3a5f; font-size: 0.9rem; text-transform: uppercase; pointer-events: none; }
        .planning-month-card input { width: 100%; text-align: center; font-weight: 600; border: 1px solid #ddd; padding: 5px; border-radius: 4px; pointer-events: none; background: white; }
        .planning-summary { margin-top: 20px; padding: 15px; background-color: #e8f5e9; border-radius: 8px; color: #2e7d32; font-weight: 600; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
        
        /* --- DETALHAMENTO DO PLANEJAMENTO (Atualizado v21 - Grid com 3 colunas) --- */
        .detail-panel { background: #fff; border: 1px solid #d1d9e6; border-radius: 8px; margin-top: 25px; padding: 20px; animation: fadeIn 0.3s ease-in-out; position: relative; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .detail-panel::before { content: ''; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); border-width: 0 10px 10px 10px; border-style: solid; border-color: transparent transparent #d1d9e6 transparent; }
        .detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .detail-header h3 { margin: 0; font-size: 1.1rem; color: #1e3a5f; }
        .detail-list { max-height: 300px; overflow-y: auto; margin-bottom: 15px; }
        
        /* NOVO CSS: CABE√áALHOS DO DETALHAMENTO */
        .detail-labels {
            display: grid;
            grid-template-columns: 3fr 1fr 1.5fr 40px; /* Igual ao .detail-item */
            gap: 10px;
            margin-bottom: 5px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #5a718c;
            padding: 0 5px;
        }

        /* ATUALIZA√á√ÉO GRID: Nome (3fr), Qtd (1fr), R$ (1.5fr), Btn (40px) */
        .detail-item { display: grid; grid-template-columns: 3fr 1fr 1.5fr 40px; gap: 10px; margin-bottom: 8px; align-items: center; }
        
        .detail-item input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .btn-mini { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; }
        .btn-add { background-color: #28a745; color: white; width: 100%; padding: 10px; margin-top: 10px; }
        .btn-remove { background-color: #dc3545; color: white; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 992px) {
            body, html { overflow-y: auto; overflow-x: hidden; }
            .sidebar-toggle { display: flex; }
            .system-container { flex-direction: column; }
            .sidebar { position: fixed; left: -300px; width: 280px; height: 100vh; z-index: 998; transition: left 0.3s ease-in-out; box-shadow: 4px 0 15px rgba(0,0,0,0.2); }
            .sidebar.is-open { left: 0; }
            .sidebar.hidden { left: -300px !important; width: 0; }
            .content-area { padding: 20px; padding-top: 70px; }
            .form-grid { grid-template-columns: 1fr; }
            .metrics { grid-template-columns: 1fr; }
            /* Ajuste mobile para o grid detalhado */
            .detail-item { grid-template-columns: 1fr 1fr 1fr 30px; gap: 5px; font-size: 0.9rem; }
            .detail-labels { grid-template-columns: 1fr 1fr 1fr 30px; gap: 5px; font-size: 0.75rem; }
        }
    </style>
</head>
<body>
    <button id="sidebar-toggle-btn" class="sidebar-toggle" aria-label="Abrir menu" aria-expanded="false">
        <span></span><span></span><span></span>
    </button>
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <div class="system-container">
        <aside class="sidebar">
            <header class="sidebar-header"><img src="imagem2.png" alt="Logo da Empresa" class="company-logo"></header>
            <nav id="main-nav"><ul></ul></nav>
            <div class="sidebar-footer"><button id="btn-adicionar-contrato">+ Adicionar Novo Contrato</button></div>
        </aside>
        <main id="content-area" class="content-area">
            <div class="welcome-message"><h1>Carregando...</h1><p>Buscando dados mais recentes.</p></div>
        </main>
    </div>

    <div id="modal-novo-contrato" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Adicionar Novo Contrato</h2><button class="close-button">&times;</button></div>
            <form id="form-novo-contrato">
                <div class="modal-body">
                    <div class="form-grid">
                        <div class="form-group"><label for="nome-curto">Nome Curto:</label><input type="text" id="nome-curto" required></div>
                        <div class="form-group"><label for="nome-completo">Nome Completo:</label><input type="text" id="nome-completo" required></div>
                        <fieldset><legend>Metas</legend><div class="form-grid">
                            <div class="form-group"><label for="meta-imob">Meta Imobiliza√ß√£o:</label><input type="number" id="meta-imob" step="0.01" min="0"></div>
                            <div class="form-group"><label for="meta-costad">Meta CostAD:</label><input type="number" id="meta-costad" step="0.01" min="0"></div>
                            <div class="form-group"><label for="meta-econ">Meta Economias:</label><input type="number" id="meta-econ" min="0"></div>
                            <div class="form-group"><label for="meta-avance">Meta Avan√ßo F√≠sico:</label><input type="number" id="meta-avance" min="0"></div>
                        </div></fieldset>
                    </div>
                </div>
                <div class="modal-footer"><button type="button" class="btn-secondary close-button">Cancelar</button><button type="submit" class="btn-primary">Salvar Contrato</button></div>
            </form>
        </div>
    </div>
    
    <div id="modal-comuniquese" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="modal-cs-title">Novo Comunique-se</h2><button class="close-button">&times;</button></div>
            <form id="form-comuniquese"><input type="hidden" id="cs-id"><div class="modal-body"><div class="form-grid"><div class="form-group"><label for="cs-protocolo">Protocolo:</label><input type="text" id="cs-protocolo" required></div><div class="form-group"><label for="cs-orgao">√ìrg√£o Emissor:</label><input type="text" id="cs-orgao" required></div><div class="form-group"><label for="cs-data-recebimento">Data Recebimento:</label><input type="date" id="cs-data-recebimento" required></div><div class="form-group"><label for="cs-prazo-dias">Prazo (Dias):</label><input type="number" id="cs-prazo-dias" min="1" required></div><div class="form-group full-width"><label for="cs-assunto">Assunto:</label><textarea id="cs-assunto" rows="2"></textarea></div><div class="form-group"><label for="cs-responsavel">Respons√°vel:</label><input type="text" id="cs-responsavel"></div><div class="form-group"><label for="cs-status">Status:</label><select id="cs-status"><option value="Pendente">Pendente</option><option value="Respondido">Respondido</option></select></div><div class="form-group"><label for="cs-data-resposta">Data Resposta:</label><input type="date" id="cs-data-resposta"></div><div class="form-group"><label for="cs-oficio-resposta">Of√≠cio Resposta:</label><input type="text" id="cs-oficio-resposta"></div><div class="form-group full-width"><label for="cs-observacao">Observa√ß√£o:</label><textarea id="cs-observacao" rows="3"></textarea></div></div></div><div class="modal-footer"><button type="button" class="btn-secondary close-button">Cancelar</button><button type="submit" class="btn-primary">Salvar</button></div></form>
        </div>
    </div>

    <script>
    let isAdmin = false;
    const GLOBAL_GOAL_ECONOMIAS = 168000;

    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        isAdmin = urlParams.get('modo') === 'edicao'; 
        const JSONBIN_URL = 'https://api.jsonbin.io/v3/b/68e8e81ad0ea881f409c51f0'; 
        const API_KEY = '$2a$10$L4n/qlQ8LGkgQmd9p7zhaOAK6j5pgA.2Tq7xK019hUqDGNfPmqJ5O'; 
        let database = { obras: [], comuniqueses: [] };
        let slideshowInterval = null;
        let currentSlide = 0;
        let slides = [];
        const navList = document.querySelector('#main-nav ul');
        const contentArea = document.getElementById('content-area');
        const sidebar = document.querySelector('.sidebar');
        
        const handlePainelTVKeyPress = (event) => { 
            if (event.key === 'ArrowRight') proximoSlide(); 
            if (event.key === 'ArrowLeft') slideAnterior(); 
        };

        const formatCurrency = (v) => (v || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const formatUnits = (v, u = '') => `${(Math.round(v) || 0).toLocaleString('pt-BR')} ${u}`.trim();
        const formatAsCompactCurrency = (v) => (v >= 1e6 ? `R$ ${(v / 1e6).toFixed(1).replace('.', ',')} mi` : (v >= 1e3 ? `R$ ${(v / 1e3).toFixed(1).replace('.', ',')} mil` : formatCurrency(v)));
        const calculatePercentage = (c, g) => (g > 0 ? (c / g) * 100 : 0);
        const formatarValorFaltante = (m, a, t, u = '', d = 1) => { const diff = m - a; if (diff <= 0) { const s = Math.abs(diff); let vf; if (t === 'currency') vf = formatCurrency(s); else vf = formatUnits(s / d, u); return `Superamos a meta em <span class="goal-surpassed">${vf}</span>`; } else { let vf; if (t === 'currency') vf = formatCurrency(diff); else vf = formatUnits(diff / d, u); return `Faltam: <span>${vf}</span>`; } };
        function getBusinessDaysBetween(startDate, endDate, holidays) { let count = 0; const curDate = new Date(Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth(), startDate.getUTCDate())); const lastDate = new Date(Date.UTC(endDate.getUTCFullYear(), endDate.getUTCMonth(), endDate.getUTCDate())); const holidaySet = new Set(holidays); while (curDate <= lastDate) { const dayOfWeek = curDate.getUTCDay(); const isoDate = curDate.toISOString().split('T')[0]; if (dayOfWeek !== 0 && dayOfWeek !== 6 && !holidaySet.has(isoDate)) { count++; } curDate.setUTCDate(curDate.getUTCDate() + 1); } return count; }

        function gerarNavegacao(obras) { 
            const activeId = navList.querySelector('a.active')?.dataset.id || 'painel-tv'; 
            navList.innerHTML = ''; 
            navList.innerHTML += `<li><a data-id="painel-tv">üì∫ Painel TV</a></li>`; 
            navList.innerHTML += `<li><a data-id="visao-geral">Vis√£o Geral</a></li>`; 
            navList.innerHTML += `<li><a data-id="comuniqueses">üìÑ Comunique-se</a></li>`; 
            navList.innerHTML += `<li><a data-id="planejamento-2026">üìÖ Planejamento 2026</a></li>`;
            navList.innerHTML += `<li><a data-id="metas-acumuladas">üìä Metas Acumuladas</a></li>`;
            if (isAdmin) navList.innerHTML += `<li><a data-id="lancar-historico" style="color: #ffc107; font-weight: 600;">üõ†Ô∏è Lan√ßar Hist√≥rico</a></li>`;
            obras.sort((a, b) => a.nomeCurto.localeCompare(b.nomeCurto)).forEach(o => { navList.innerHTML += `<li><a data-id="${o.id}">${o.nomeCurto}</a></li>`; }); 
            const linkAtivo = navList.querySelector(`a[data-id="${activeId}"]`) || navList.querySelector('a'); 
            if (linkAtivo) linkAtivo.classList.add('active'); 
            navList.querySelectorAll('a').forEach(l => l.addEventListener('click', handleNavClick)); 
        }
        
        function mostrarVisaoGeral(obras){
             const tImobM = obras.reduce((s, o) => s + o.dadosImobilizacao.meta, 0); const tImobA = obras.reduce((s, o) => s + o.dadosImobilizacao.atual, 0); const tCostADM = obras.reduce((s, o) => s + (o.dadosCostAD ? o.dadosCostAD.meta : 0), 0); const tCostADA = obras.reduce((s, o) => s + (o.dadosCostAD ? o.dadosCostAD.atual : 0), 0); const tEconA = obras.reduce((s, o) => s + o.dadosEconomia.atual, 0); const tEconMeta26 = GLOBAL_GOAL_ECONOMIAS - tEconA; const pEconGlobal = calculatePercentage(tEconA, GLOBAL_GOAL_ECONOMIAS); const tAvanceM = obras.reduce((s, o) => s + o.dadosAvanceFisico.meta, 0); const tAvanceA = obras.reduce((s, o) => s + o.dadosAvanceFisico.atual, 0); const saldoAvance26 = tAvanceM - tAvanceA; const pImob = calculatePercentage(tImobA, tImobM); const pCostAD = calculatePercentage(tCostADA, tCostADM); const pAvance = calculatePercentage(tAvanceA, tAvanceM); const contagemContratosVisiveis = obras.filter(o => o.nomeCurto !== 'Varzeas A').length;
             contentArea.innerHTML = `<div class="content-header"><div><h1>Vis√£o Geral da Coordena√ß√£o - Leste 2</h1><p>Resumo de todos os contratos.</p></div></div><div class="dashboard-grid"><section class="metrics"><figure class="metric-card"><figcaption class="label">Contratos Ativos</figcaption><div class="value">${contagemContratosVisiveis}</div></figure><figure class="metric-card"><figcaption class="label">Imobiliza√ß√£o (Total)</figcaption><div class="value goal">${formatAsCompactCurrency(tImobM)}</div></figure><figure class="metric-card"><figcaption class="label">CostAD (Total)</figcaption><div class="value goal">${formatAsCompactCurrency(tCostADM)}</div></figure><figure class="metric-card"><figcaption class="label">Economias (Global)</figcaption><div class="value goal">${formatUnits(GLOBAL_GOAL_ECONOMIAS)}</div></figure></section><section class="metric-card progress-card"><h3>Progresso: Meta Imobiliza√ß√£o 2025</h3><div class="progress-bar-container"><div class="progress-bar-fill" style="width:${pImob > 100 ? 100 : pImob.toFixed(2)}%;">${pImob.toFixed(1).replace('.', ',')}%</div></div><div class="progress-details"><div>${formatarValorFaltante(tImobM, tImobA, 'currency')}</div><div>Executado: <span>${formatCurrency(tImobA)}</span></div><div>Meta 2025: <span>${formatCurrency(tImobM)}</span></div></div></section><section class="metric-card progress-card"><h3>Progresso: CostAD / Desembolso</h3><div class="progress-bar-container"><div class="progress-bar-fill" style="width:${pCostAD > 100 ? 100 : pCostAD.toFixed(2)}%; background-color: #6f42c1;">${pCostAD.toFixed(1).replace('.', ',')}%</div></div><div class="progress-details"><div>${formatarValorFaltante(tCostADM, tCostADA, 'currency')}</div><div>Executado: <span>${formatCurrency(tCostADA)}</span></div><div>Meta Total: <span>${formatCurrency(tCostADM)}</span></div></div></section><section class="metric-card progress-card"><h3>Progresso: Economias (Meta Global)</h3><div class="progress-bar-container"><div class="progress-bar-fill" style="width:${pEconGlobal > 100 ? 100 : pEconGlobal.toFixed(2)}%;background-color:#ff9800;">${pEconGlobal.toFixed(1).replace('.', ',')}%</div></div><div class="progress-details"><div>Meta 2026 (Restante): <span>${formatUnits(tEconMeta26)}</span></div><div>Realizado Total: <span>${formatUnits(tEconA)}</span></div><div>Meta Global: <span>${formatUnits(GLOBAL_GOAL_ECONOMIAS)}</span></div></div></section><section class="metric-card progress-card"><h3>Progresso: Avan√ßo F√≠sico</h3><div class="progress-bar-sewage"><div class="progress-bar-fill-sewage" style="width:${pAvance > 100 ? 100 : pAvance.toFixed(2)}%;">${pAvance.toFixed(1).replace('.', ',')}%</div></div><div class="progress-details"><div>Meta 2026 (Restante): <span>${formatUnits(saldoAvance26, 'm')}</span></div><div>Executado Total: <span>${formatUnits(tAvanceA, 'm')}</span></div><div>Extens√£o Total: <span>${formatUnits(tAvanceM, 'm')}</span></div></div></section></div>`; 
        }
        function mostrarPaginaObra(o){
             if (!o.dadosCostAD) o.dadosCostAD = { meta: 0, atual: 0 }; const pI = calculatePercentage(o.dadosImobilizacao.atual, o.dadosImobilizacao.meta); const pC = calculatePercentage(o.dadosCostAD.atual, o.dadosCostAD.meta); const pE = calculatePercentage(o.dadosEconomia.atual, o.dadosEconomia.meta); const pA = calculatePercentage(o.dadosAvanceFisico.atual, o.dadosAvanceFisico.meta); const vIf = (o.dadosImobilizacao.atual || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 }); const vCf = (o.dadosCostAD.atual || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 }); const readOnlyState = !isAdmin ? 'readonly' : ''; const adminOnlyDisplay = !isAdmin ? 'style="display:none;"' : ''; const restanteEcon = o.dadosEconomia.meta - o.dadosEconomia.atual; const restanteAvance = o.dadosAvanceFisico.meta - o.dadosAvanceFisico.atual;
             contentArea.innerHTML = `<div class="content-header"><div><h1>${o.nomeCompleto}</h1><p>Acompanhamento detalhado.</p></div></div><div class="dashboard-grid"><section class="metric-card progress-card"><h3>Meta Imobiliza√ß√£o 2025</h3><div class="input-area"><label for="input-imob">Valor Realizado:</label><div class="input-wrapper"><span class="currency-symbol">R$</span><input type="text" id="input-imob" data-obra-id="${o.id}" data-tipo="imobilizacao" value="${vIf}" ${readOnlyState}></div></div><div class="progress-bar-container"><div class="progress-bar-fill" style="width:${pI > 100 ? 100 : pI.toFixed(2)}%;">${pI.toFixed(1).replace('.', ',')}%</div></div><div class="progress-details"><div>${formatarValorFaltante(o.dadosImobilizacao.meta, o.dadosImobilizacao.atual, 'currency')}</div><div>Meta: <span>${formatCurrency(o.dadosImobilizacao.meta)}</span></div></div></section><section class="metric-card progress-card"><h3>CostAD (Desembolso)</h3><div class="input-area"><label for="input-costad">Valor Realizado:</label><div class="input-wrapper"><span class="currency-symbol">R$</span><input type="text" id="input-costad" data-obra-id="${o.id}" data-tipo="costad" value="${vCf}" ${readOnlyState}></div></div><div class="progress-bar-container"><div class="progress-bar-fill" style="width:${pC > 100 ? 100 : pC.toFixed(2)}%; background-color: #6f42c1;">${pC.toFixed(1).replace('.', ',')}%</div></div><div class="progress-details"><div>${formatarValorFaltante(o.dadosCostAD.meta, o.dadosCostAD.atual, 'currency')}</div><div>Meta: <span>${formatCurrency(o.dadosCostAD.meta)}</span></div></div></section><section class="metric-card progress-card"><h3>Economias</h3><div class="input-area"><label for="input-econ">Economias Atendidas:</label><div class="input-wrapper"><input type="text" id="input-econ" class="no-symbol" data-obra-id="${o.id}" data-tipo="economia" value="${(o.dadosEconomia.atual || 0).toLocaleString('pt-BR')}" ${readOnlyState}></div></div><div class="progress-bar-container"><div class="progress-bar-fill" style="width:${pE > 100 ? 100 : pE.toFixed(2)}%;background-color:#ff9800;">${pE.toFixed(1).replace('.', ',')}%</div></div><div class="progress-details"><div>${formatarValorFaltante(o.dadosEconomia.meta, o.dadosEconomia.atual, 'units', 'economias')}</div><div>Meta Total: <span>${formatUnits(o.dadosEconomia.meta)}</span></div><div>Meta 2026 (Restante): <span>${formatUnits(restanteEcon < 0 ? 0 : restanteEcon)}</span></div></div></section><section class="metric-card progress-card"><h3>Avan√ßo F√≠sico (m)</h3><div class="input-area"><label for="input-avance">Metros Executados:</label><div class="input-wrapper"><input type="text" id="input-avance" class="no-symbol" data-obra-id="${o.id}" data-tipo="avance" value="${(o.dadosAvanceFisico.atual || 0).toLocaleString('pt-BR')}" ${readOnlyState}></div></div><div class="progress-bar-sewage"><div class="progress-bar-fill-sewage" style="width:${pA > 100 ? 100 : pA.toFixed(2)}%;">${pA.toFixed(1).replace('.', ',')}%</div></div><div class="progress-details"><div>${formatarValorFaltante(o.dadosAvanceFisico.meta, o.dadosAvanceFisico.atual, 'units', 'm')}</div><div>Meta Total: <span>${formatUnits(o.dadosAvanceFisico.meta, 'm')}</span></div><div>Meta 2026 (Restante): <span>${formatUnits(restanteAvance < 0 ? 0 : restanteAvance, 'm')}</span></div></div></section><section class="metric-card danger-zone" ${adminOnlyDisplay}><h3>Zona de Perigo</h3><p>A exclus√£o de um contrato √© permanente.</p><button id="btn-excluir-contrato" data-obra-id="${o.id}">Excluir Contrato</button></section></div>`; if (isAdmin) { contentArea.querySelectorAll('input[type="text"]').forEach(i => { i.addEventListener('input', handleInputFormatting); i.addEventListener('change', handleInputChange); }); const btnExcluir = document.getElementById('btn-excluir-contrato'); if (btnExcluir) { btnExcluir.addEventListener('click', handleExcluirClick); } }
        }
        
        function proximoSlide() { if (slides.length === 0) return; slides[currentSlide].classList.remove('active'); currentSlide = (currentSlide + 1) % slides.length; slides[currentSlide].classList.add('active'); reiniciarTimerSlideshow(); }
        function slideAnterior() { if (slides.length === 0) return; slides[currentSlide].classList.remove('active'); currentSlide = (currentSlide - 1 + slides.length) % slides.length; slides[currentSlide].classList.add('active'); reiniciarTimerSlideshow(); }
        function reiniciarTimerSlideshow() { clearInterval(slideshowInterval); slideshowInterval = setInterval(proximoSlide, 10000); }
        
        function mostrarPainelTV(){
             const eI = new Date(Date.UTC(2026, 11, 15)), eE = new Date(Date.UTC(2026, 11, 31)), eA = new Date(Date.UTC(2026, 11, 31)); const localToday = new Date(); const today = new Date(Date.UTC(localToday.getUTCFullYear(), localToday.getUTCMonth(), localToday.getUTCDate())); const H = ['2025-10-12', '2025-11-02', '2025-11-15', '2025-12-25', '2026-01-01', '2026-04-03', '2026-04-21', '2026-05-01', '2026-06-04', '2026-09-07', '2026-10-12', '2026-11-02', '2026-11-15', '2026-12-25']; const tI = database.obras.reduce((s, o) => s + o.dadosImobilizacao.meta, 0); const aI = database.obras.reduce((s, o) => s + o.dadosImobilizacao.atual, 0); const tC = database.obras.reduce((s, o) => s + (o.dadosCostAD ? o.dadosCostAD.meta : 0), 0); const aC = database.obras.reduce((s, o) => s + (o.dadosCostAD ? o.dadosCostAD.atual : 0), 0); const aE = database.obras.reduce((s, o) => s + o.dadosEconomia.atual, 0); const tEMeta26 = GLOBAL_GOAL_ECONOMIAS - aE; const tAMetaTotal = database.obras.reduce((s, o) => s + o.dadosAvanceFisico.meta, 0); const aA = database.obras.reduce((s, o) => s + o.dadosAvanceFisico.atual, 0); const tAMeta26 = tAMetaTotal - aA; const bDI = getBusinessDaysBetween(today, eI, H), bDE = getBusinessDaysBetween(today, eE, H), bDA = getBusinessDaysBetween(today, eA, H); const dIT = bDI > 0 ? (tI - aI) / bDI : 0; const dCT = bDI > 0 ? (tC - aC) / bDI : 0; const dET = bDE > 0 ? (tEMeta26) / bDE : 0; const dAT = bDA > 0 ? (tAMeta26) / bDA : 0; const pI = calculatePercentage(aI, tI); const pC = calculatePercentage(aC, tC); const pE = calculatePercentage(aE, GLOBAL_GOAL_ECONOMIAS); const pA = calculatePercentage(aA, tAMetaTotal); 
             contentArea.innerHTML = `<div class="slideshow-wrapper"><div class="slideshow-header"><h1>Painel TV</h1><button class="fullscreen-button" title="Modo Tela Cheia">üì∫</button></div><div class="slideshow-content"></div><button class="exit-fullscreen-button">Sair</button></div>`; const sC = contentArea.querySelector('.slideshow-content'); sC.innerHTML = `<div class="panel-slide"><h2>Meta Imobiliza√ß√£o 2025</h2><div class="progress-bar-container"><div class="progress-bar-fill" style="width:${pI > 100 ? 100 : pI.toFixed(2)}%;">${pI.toFixed(1).replace('.', ',')}%</div></div><div class="progress-details"><div>${formatarValorFaltante(tI, aI, 'currency')}</div><div>Executado: <span>${formatCurrency(aI)}</span></div><div>Meta 2025: <span>${formatCurrency(tI)}</span></div><div>Meta Di√°ria: <span>${formatCurrency(dIT)}</span></div><div>Dias √öteis: <span>${bDI}</span></div></div><div class="calendars" id="calendars-imob"></div></div>` + `<div class="panel-slide"><h2>CostAD (Desembolso)</h2><div class="progress-bar-container"><div class="progress-bar-fill" style="width:${pC > 100 ? 100 : pC.toFixed(2)}%; background-color: #6f42c1;">${pC.toFixed(1).replace('.', ',')}%</div></div><div class="progress-details"><div>${formatarValorFaltante(tC, aC, 'currency')}</div><div>Executado: <span>${formatCurrency(aC)}</span></div><div>Meta Total: <span>${formatCurrency(tC)}</span></div><div>Meta Di√°ria: <span>${formatCurrency(dCT)}</span></div><div>Dias √öteis: <span>${bDI}</span></div></div><div class="calendars" id="calendars-costad"></div></div>` + `<div class="panel-slide"><h2>Meta Economias 2026</h2><div class="progress-bar-container"><div class="progress-bar-fill" style="width:${pE > 100 ? 100 : pE.toFixed(2)}%;background-color:#ff9800;">${pE.toFixed(1).replace('.', ',')}%</div></div><div class="progress-details"><div>Faltam para Meta Global: <span>${formatUnits(tEMeta26)}</span></div><div>Alcan√ßado: <span>${formatUnits(aE)}</span></div><div>Meta Global: <span>${formatUnits(GLOBAL_GOAL_ECONOMIAS)}</span></div><div>Meta Di√°ria (Restante): <span>${formatUnits(dET)}</span></div><div>Dias √öteis: <span>${bDE}</span></div></div><div class="calendars" id="calendars-econ"></div></div>` + `<div class="panel-slide"><h2>Meta Avan√ßo F√≠sico 2026</h2><div class="progress-bar-sewage"><div class="progress-bar-fill-sewage" style="width:${pA > 100 ? 100 : pA.toFixed(2)}%;">${pA.toFixed(1).replace('.', ',')}%</div></div><div class="progress-details"><div>Faltam para Meta Total: <span>${formatUnits(tAMeta26, 'm')}</span></div><div>Executado: <span>${formatUnits(aA, 'm')}</span></div><div>Meta Total: <span>${formatUnits(tAMetaTotal, 'm')}</span></div><div>Meta Di√°ria (Restante): <span>${formatUnits(dAT, 'm')}</span></div><div>Dias √öteis: <span>${bDA}</span></div></div><div class="calendars" id="calendars-avance"></div></div>`; const { renderAllCalendars } = setupCalendarLogic(H); renderAllCalendars(today, eI, sC.querySelector('#calendars-imob')); renderAllCalendars(today, eI, sC.querySelector('#calendars-costad')); renderAllCalendars(today, eE, sC.querySelector('#calendars-econ')); renderAllCalendars(today, eA, sC.querySelector('#calendars-avance')); slides = sC.querySelectorAll('.panel-slide'); currentSlide = 0; if (slides.length > 0) { slides[currentSlide].classList.add('active'); reiniciarTimerSlideshow(); } document.querySelector('.fullscreen-button').addEventListener('click', enterFullScreenMode); document.querySelector('.exit-fullscreen-button').addEventListener('click', exitFullScreenMode); document.addEventListener('keydown', handlePainelTVKeyPress); 
        }
        function setupCalendarLogic(h) { const holidaySet = new Set(h); function rM(y, m, gC, tED) { const localToday = new Date(); const today = new Date(Date.UTC(localToday.getUTCFullYear(), localToday.getUTCMonth(), localToday.getUTCDate())); const fD = new Date(y, m, 1), dIM = new Date(y, m + 1, 0).getDate(), sDOW = fD.getDay(); let gCs = []; gCs.push('<div class="week-number-header"></div>'); ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'].forEach(n => gCs.push(`<div class="day-name">${n}</div>`)); for (let i = 0; i < sDOW; i++) gCs.push('<div class="empty-day"></div>'); for (let d = 1; d <= dIM; d++) { const cD = new Date(Date.UTC(y, m, d)); const cDOW = cD.getUTCDay(); if (cDOW === 0) gCs.push(`<div class="week-number">${gWN(cD)}</div>`); let cls = ['day']; if (cD.getTime() === today.getTime()) { cls.push('today'); } else if (cD < today) { cls.push('past-day'); } if (cD.getTime() === tED.getTime()) { cls.push('end-date'); } else if (cD > today && cD <= tED) { const iso = cD.toISOString().split('T')[0]; if (holidaySet.has(iso)) cls.push('holiday'); else if (cDOW === 0 || cDOW === 6) cls.push('weekend'); else cls.push('future-workday'); } gCs.push(`<div class="${cls.join(' ')}"><span class="day-of-month">${d}</span></div>`); } gC.innerHTML = gCs.join(''); } function gWN(d) { d = new Date(d); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7)); const yS = new Date(Date.UTC(d.getUTCFullYear(), 0, 1)); const wN = Math.ceil((((d - yS) / 864e5) + 1) / 7); return wN; } return { renderAllCalendars: function (s, e, c) { if (!c) return; c.innerHTML = ''; const mN = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"]; let cD = new Date(s.getUTCFullYear(), s.getUTCMonth(), 1); while (cD <= e) { const y = cD.getFullYear(), m = cD.getMonth(); const mC = document.createElement('div'); mC.className = 'month'; mC.innerHTML = `<h3>${mN[m]} ${y}</h3><div class="calendar-grid"></div>`; const cG = mC.querySelector('.calendar-grid'); rM(y, m, cG, e); c.appendChild(mC); cD.setMonth(cD.getMonth() + 1); } } }; }

        // =========================================================================
        // GLOBALS E CORRE√á√ïES (v15 e v16)
        // =========================================================================

        window.handleInputFormatting = function(e) { 
            const i = e.target, t = i.dataset.tipo; 
            let v = i.value.replace(/\D/g, ''); 
            if (v === '') { i.value = ''; return; } 
            if (t && (t.includes('imobilizacao') || t.includes('costad'))) { 
                const nV = parseInt(v, 10) / 100; 
                i.value = nV.toLocaleString('pt-BR', { minimumFractionDigits: 2 }); 
            } else { 
                i.value = parseInt(v, 10).toLocaleString('pt-BR'); 
            } 
        }

        window.mostrarPlanejamento2026 = function(obraIdSelecionada = null) {
            const obras = database.obras.sort((a, b) => a.nomeCurto.localeCompare(b.nomeCurto));
            
            // ==========================================
            // LOGICA NOVA: C√ÅLCULO DA COORDENA√á√ÉO GERAL
            // ==========================================
            const coordGeral = calculaDadosCoordenacao(obras);
            
            // Se nenhum ID selecionado, ou se for coord-geral, mostra a geral
            const isCoordMode = !obraIdSelecionada || obraIdSelecionada === 'coord-geral';
            let obraAtiva = isCoordMode ? coordGeral : obras.find(o => o.id === obraIdSelecionada);

            if (!obraAtiva) obraAtiva = coordGeral;

            // Inicializar estruturas (se for obra real)
            if (!isCoordMode) {
                if (!obraAtiva.planejamento2026) obraAtiva.planejamento2026 = Array(12).fill(0);
                if (!obraAtiva.planejamentoDetalhes) obraAtiva.planejamentoDetalhes = {}; 
            }

            // Metas 2026
            const metaGlobal = obraAtiva.dadosEconomia.meta || 0;
            const realizado2025 = obraAtiva.dadosEconomia.realizado2025 || 0;
            const meta2026 = metaGlobal - realizado2025;

            // Tabs: Inclui o bot√£o de Coordena√ß√£o Geral primeiro
            let tabsHtml = `
                 <button class="planning-tab-btn ${isCoordMode ? 'active' : ''}" 
                        onclick="window.mostrarPlanejamento2026('coord-geral')" style="color: #6f42c1; font-weight:700;">
                    üèõÔ∏è EML 2
                </button>
            `;
            
            tabsHtml += obras.map(o => `
                <button class="planning-tab-btn ${o.id === obraAtiva.id ? 'active' : ''}" 
                        onclick="window.mostrarPlanejamento2026('${o.id}')">
                    ${o.nomeCurto}
                </button>
            `).join('');

            const meses = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            let inputsHtml = '<div class="planning-grid">';
            let totalPlanejado = 0;

            meses.forEach((mes, index) => {
                const valorEcon = obraAtiva.planejamento2026[index] || 0;
                totalPlanejado += valorEcon;
                
                // Calcula o Total de Imobiliza√ß√£o Dinamicamente (iterando os detalhes)
                let totalImobMes = 0;
                if(obraAtiva.planejamentoDetalhes && obraAtiva.planejamentoDetalhes[index]) {
                     totalImobMes = obraAtiva.planejamentoDetalhes[index].reduce((acc, item) => acc + (item.valorImob || 0), 0);
                }

                const hasDetails = obraAtiva.planejamentoDetalhes[index] && obraAtiva.planejamentoDetalhes[index].length > 0;
                const cardClass = hasDetails ? 'planning-month-card active-month' : 'planning-month-card';
                
                // NOVO LAYOUT DO CARD: ECONOMIAS + R$ IMOB
                inputsHtml += `
                    <div class="${cardClass}" onclick="window.abrirDetalhesMes('${obraAtiva.id}', ${index}, '${mes}')">
                        <h4>${mes}</h4>
                        <div class="input-wrapper">
                            <input type="text" value="${valorEcon.toLocaleString('pt-BR')}" readonly style="color: #007bff;">
                            <span style="font-size: 0.8rem; color: #888; display:block; margin-top:5px;">Economias</span>
                        </div>
                        <div class="input-wrapper" style="margin-top: 10px; border-top: 1px solid #eee; padding-top: 5px;">
                            <input type="text" value="${totalImobMes.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}" readonly style="color: #28a745; font-size: 0.9rem;">
                            <span style="font-size: 0.75rem; color: #888; display:block; margin-top:2px;">R$ Imobiliza√ß√£o</span>
                        </div>
                    </div>
                `;
            });
            inputsHtml += '</div>';
            
            const saldo = meta2026 - totalPlanejado;
            const statusClass = saldo < 0 ? 'prazo-vencido' : (saldo === 0 ? 'goal-surpassed' : '');
            const statusTexto = saldo < 0 ? `Ultrapassou a Meta 2026 em ${Math.abs(saldo)}` : (saldo === 0 ? 'Planejamento Bate com a Meta 2026!' : `Faltam planejar para 2026: ${saldo}`);

            // Bot√£o de Importa√ß√£o: Esconde se estiver na aba Coordena√ß√£o
            const adminButton = (isAdmin && !isCoordMode) ? 
                `<button onclick="triggerImportacaoExcel()" class="btn-primary" style="background-color: #28a745; margin-left: 20px;">üìÇ Importar Excel</button>` : '';

            contentArea.innerHTML = `
                <div class="content-header">
                    <div style="display:flex; align-items:center; flex-wrap:wrap; gap:10px;">
                        <div>
                            <h1>Planejamento de Entregas 2026</h1>
                            <p>Clique no m√™s para detalhar.</p>
                        </div>
                        ${adminButton}
                    </div>
                </div>
                <div class="planning-tabs">${tabsHtml}</div>
                <div class="metric-card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px; flex-wrap: wrap; gap: 20px;">
                        <h3>${obraAtiva.nomeCompleto}</h3>
                        <div style="text-align:right; display:flex; gap: 15px;">
                            <div><span style="display:block; font-size: 0.8rem; color:#666;">Meta Global (Total)</span><strong style="font-size: 1rem; color:#5a718c;">${metaGlobal.toLocaleString('pt-BR')} un.</strong></div>
                            <div><span style="display:block; font-size: 0.8rem; color:#666;">(-) Executado 2025</span><strong style="font-size: 1rem; color:#c82333;">${realizado2025.toLocaleString('pt-BR')} un.</strong></div>
                            <div style="border-left: 2px solid #eee; padding-left: 15px;"><span style="display:block; font-size: 0.9rem; color:#1e3a5f; font-weight:700;">(=) Meta 2026</span><strong style="font-size: 1.4rem; color:#1e3a5f;">${meta2026.toLocaleString('pt-BR')} un.</strong></div>
                        </div>
                    </div>
                    ${inputsHtml}
                    <div class="planning-summary"><span>Total Planejado (Soma dos Meses): ${totalPlanejado.toLocaleString('pt-BR')}</span><span class="${statusClass}">${statusTexto}</span></div>
                    
                    <div id="planning-details-container"></div>
                </div>
            `;
        }

        // Fun√ß√£o Auxiliar para Criar o Objeto Virtual da Coordena√ß√£o
        function calculaDadosCoordenacao(obras) {
            const coord = {
                id: 'coord-geral',
                nomeCurto: 'Coordena√ß√£o Geral',
                nomeCompleto: 'Vis√£o Consolidada - Leste 2',
                dadosEconomia: { meta: 0, realizado2025: 0 },
                planejamento2026: Array(12).fill(0),
                planejamentoDetalhes: {} 
            };

            obras.forEach(o => {
                coord.dadosEconomia.meta += (o.dadosEconomia.meta || 0);
                coord.dadosEconomia.realizado2025 += (o.dadosEconomia.realizado2025 || 0);

                // Somar m√™s a m√™s
                if(o.planejamento2026) {
                    o.planejamento2026.forEach((val, idx) => {
                        coord.planejamento2026[idx] += val;
                    });
                }
                
                // Criar detalhes agregados (Detalhe = Contrato)
                if(o.planejamentoDetalhes) {
                    for(let i=0; i<12; i++) {
                        if(o.planejamentoDetalhes[i] && o.planejamentoDetalhes[i].length > 0) {
                            if(!coord.planejamentoDetalhes[i]) coord.planejamentoDetalhes[i] = [];
                            
                            // Calcula totais deste contrato neste m√™s
                            const totalEconContrato = o.planejamentoDetalhes[i].reduce((acc, item) => acc + (item.valor || 0), 0);
                            const totalImobContrato = o.planejamentoDetalhes[i].reduce((acc, item) => acc + (item.valorImob || 0), 0);
                            
                            if (totalEconContrato > 0 || totalImobContrato > 0) {
                                coord.planejamentoDetalhes[i].push({
                                    nome: o.nomeCurto, // Nome da Obra vira o "Item"
                                    valor: totalEconContrato,
                                    valorImob: totalImobContrato,
                                    isAggregate: true // Flag para saber que n√£o pode editar
                                });
                            }
                        }
                    }
                }
            });
            return coord;
        }

        // v22: Header nos Detalhes
        window.abrirDetalhesMes = function(obraId, mesIndex, nomeMes) {
            const container = document.getElementById('planning-details-container');
            
            // Verifica se √© Coordena√ß√£o ou Obra Real
            let obra;
            let isCoordMode = false;
            if (obraId === 'coord-geral') {
                obra = calculaDadosCoordenacao(database.obras);
                isCoordMode = true;
            } else {
                obra = database.obras.find(o => o.id === obraId);
            }

            if (!obra) return;
            if (!obra.planejamentoDetalhes) obra.planejamentoDetalhes = {};
            const detalhes = obra.planejamentoDetalhes[mesIndex] || [];
            
            // Se for Coordena√ß√£o, os itens s√£o apenas leitura
            const readOnlyAttr = (isCoordMode || !isAdmin) ? 'readonly' : '';

            const listaHtml = detalhes.map((item, idx) => `
                <div class="detail-item">
                    <input type="text" placeholder="Nome do Local" value="${item.nome}" onchange="window.atualizarItemDetalhe('${obraId}', ${mesIndex}, ${idx}, 'nome', this.value)" ${readOnlyAttr}>
                    <input type="number" placeholder="Qtd" value="${item.valor}" onchange="window.atualizarItemDetalhe('${obraId}', ${mesIndex}, ${idx}, 'valor', this.value)" ${readOnlyAttr}>
                    <input type="number" step="0.01" placeholder="R$ Imob." value="${item.valorImob || 0}" onchange="window.atualizarItemDetalhe('${obraId}', ${mesIndex}, ${idx}, 'valorImob', this.value)" ${readOnlyAttr}>
                    ${(!isCoordMode && isAdmin) ? `<button class="btn-mini btn-remove" onclick="window.removerItemDetalhe('${obraId}', ${mesIndex}, ${idx})">&times;</button>` : ''}
                </div>
            `).join('');

            const headerLabel = isCoordMode ? "Contratos com Produ√ß√£o neste M√™s" : "Detalhamento de Locais";

            container.innerHTML = `
                <div class="detail-panel">
                    <div class="detail-header">
                        <h3>${headerLabel}: ${nomeMes}</h3>
                        <button class="btn-mini btn-secondary" onclick="document.getElementById('planning-details-container').innerHTML = ''">Fechar</button>
                    </div>

                    <div class="detail-labels">
                        <span>${isCoordMode ? 'Contrato' : 'Local / Sub-trecho'}</span>
                        <span>Economias</span>
                        <span>Valor Imob. (R$)</span>
                        <span></span>
                    </div>

                    <div class="detail-list">
                        ${listaHtml.length > 0 ? listaHtml : '<p style="color:#888; font-style:italic;">Nenhum registro para este m√™s.</p>'}
                    </div>
                    ${(!isCoordMode && isAdmin) ? `<button class="btn-mini btn-add" onclick="window.adicionarItemDetalhe('${obraId}', ${mesIndex})">+ Adicionar Local</button>` : ''}
                </div>
            `;
        }

        window.adicionarItemDetalhe = function(obraId, mesIndex) {
            if(obraId === 'coord-geral') return; // Seguran√ßa
            const obra = database.obras.find(o => o.id === obraId);
            if(!obra.planejamentoDetalhes[mesIndex]) obra.planejamentoDetalhes[mesIndex] = [];
            obra.planejamentoDetalhes[mesIndex].push({ nome: '', valor: 0, valorImob: 0 });
            window.recalcularTotalMes(obraId, mesIndex);
            window.abrirDetalhesMes(obraId, mesIndex, obterNomeMes(mesIndex));
        }

        window.removerItemDetalhe = function(obraId, mesIndex, itemIndex) {
            if(obraId === 'coord-geral') return;
            const obra = database.obras.find(o => o.id === obraId);
            obra.planejamentoDetalhes[mesIndex].splice(itemIndex, 1);
            window.recalcularTotalMes(obraId, mesIndex);
            window.abrirDetalhesMes(obraId, mesIndex, obterNomeMes(mesIndex));
        }

        window.atualizarItemDetalhe = function(obraId, mesIndex, itemIndex, campo, valor) {
            if(obraId === 'coord-geral') return;
            const obra = database.obras.find(o => o.id === obraId);
            
            if (campo === 'valor') {
                valor = parseInt(valor) || 0;
            } else if (campo === 'valorImob') {
                valor = parseFloat(valor) || 0;
            }

            obra.planejamentoDetalhes[mesIndex][itemIndex][campo] = valor;
            if (campo === 'valor') window.recalcularTotalMes(obraId, mesIndex);
            if (campo === 'valorImob') salvarDados();
        }

        window.recalcularTotalMes = function(obraId, mesIndex) {
            const obra = database.obras.find(o => o.id === obraId);
            const detalhes = obra.planejamentoDetalhes[mesIndex] || [];
            const total = detalhes.reduce((acc, item) => acc + (item.valor || 0), 0);
            
            // Atualiza o total principal
            obra.planejamento2026[mesIndex] = total;
            salvarDados();
            
            // Atualiza a visualiza√ß√£o principal (sem fechar os detalhes)
            setTimeout(() => {
                const nomeMes = obterNomeMes(mesIndex);
                window.mostrarPlanejamento2026(obraId);
                window.abrirDetalhesMes(obraId, mesIndex, nomeMes);
            }, 100);
        }
        
        function obterNomeMes(i) { return ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"][i]; }

        // -------------------------------------------------------------------------
        
        // ==========================================
        // M√ìDULO DE IMPORTA√á√ÉO DE EXCEL (ATUALIZADO v21 - Suporte Imob)
        // ==========================================
        window.triggerImportacaoExcel = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx, .xls, .csv';
            input.onchange = e => window.processarImportacaoExcel(e.target.files[0]);
            input.click();
        }

        window.processarImportacaoExcel = function(file) {
            if (!file) return;

            if (!isAdmin) {
                alert("Apenas administradores podem importar dados.");
                return;
            }

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (jsonData.length > 0) jsonData.shift(); // Remove cabe√ßalho

                    let importadosCount = 0;
                    let erros = [];
                    const obrasAfetadas = new Set();

                    console.log("Iniciando processamento de " + jsonData.length + " linhas...");

                    jsonData.forEach((row, index) => {
                        // A: Contrato, B: Local, C: Data, D: Qtd, E: Valor Imob (Novo)
                        const contratoNome = row[0]; 
                        const nomeLocal = row[1];    
                        const dataRaw = row[2];      
                        const qtd = parseInt(row[3]) || 0;
                        const valorImob = parseFloat(row[4]) || 0; // Coluna E

                        if (!contratoNome || !dataRaw) return;

                        const obra = database.obras.find(o => 
                            o.nomeCurto.trim().toLowerCase() === contratoNome.toString().trim().toLowerCase()
                        );

                        if (!obra) {
                            erros.push(`Linha ${index + 2}: Contrato "${contratoNome}" n√£o encontrado.`);
                            return;
                        }

                        // --- PARSER INTELIGENTE DE DATAS ---
                        let dataObj;
                        
                        if (dataRaw instanceof Date) {
                            dataObj = dataRaw;
                        } 
                        else {
                            const stringData = String(dataRaw).toLowerCase().trim();
                            const partes = stringData.split('/'); // Tenta dividir por barra

                            if (partes.length === 3) {
                                // Formato dd/mm/aaaa
                                dataObj = new Date(partes[2], partes[1] - 1, partes[0]);
                            } 
                            else if (partes.length === 2) {
                                // Formato mmm/aaaa ou mmm/aa (Ex: jan/2026, fev/26)
                                const mesesAbv = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
                                const mesTexto = partes[0].substring(0, 3); // Garante 3 letras
                                const mesIndex = mesesAbv.indexOf(mesTexto);
                                
                                let anoTexto = partes[1];
                                if (anoTexto.length === 2) anoTexto = "20" + anoTexto; // Transforma 26 em 2026

                                if (mesIndex > -1) {
                                    dataObj = new Date(anoTexto, mesIndex, 15); // Dia 15 para evitar fuso hor√°rio
                                }
                            }
                        }

                        if (!dataObj || isNaN(dataObj.getTime())) {
                            erros.push(`Linha ${index + 2}: Data inv√°lida ("${dataRaw}") para "${nomeLocal}". Use dd/mm/aaaa ou mmm/aaaa.`);
                            return;
                        }
                        // ---------------------------------------------

                        const mesIndex = dataObj.getMonth();

                        if (!obra.planejamentoDetalhes) obra.planejamentoDetalhes = {};
                        if (!obra.planejamentoDetalhes[mesIndex]) obra.planejamentoDetalhes[mesIndex] = [];

                        obra.planejamentoDetalhes[mesIndex].push({
                            nome: nomeLocal || 'Importado Excel',
                            valor: qtd,
                            valorImob: valorImob
                        });

                        // Recalcular Total Mes (apenas qtd conta para meta)
                        const totalMes = obra.planejamentoDetalhes[mesIndex].reduce((acc, item) => acc + (item.valor || 0), 0);
                        if (!obra.planejamento2026) obra.planejamento2026 = Array(12).fill(0);
                        obra.planejamento2026[mesIndex] = totalMes;

                        importadosCount++;
                        obrasAfetadas.add(obra.id);
                    });

                    let msg = `Processamento conclu√≠do!\n${importadosCount} registros importados com sucesso.`;
                    if (erros.length > 0) {
                        msg += `\n\nErros (${erros.length}):\n` + erros.slice(0, 5).join('\n') + (erros.length > 5 ? '\n...' : '');
                    }
                    alert(msg);

                    if (importadosCount > 0) {
                        salvarDados(true);
                        // Se estivermos na tela de planejamento, recarregar a obra atual se ela foi afetada
                        if(obrasAfetadas.size > 0) {
                           const firstObra = obrasAfetadas.values().next().value;
                           window.mostrarPlanejamento2026(firstObra);
                        } else {
                           window.mostrarPlanejamento2026();
                        }
                    }

                } catch (err) {
                    console.error(err);
                    alert("Erro ao ler o arquivo. Verifique se √© um Excel v√°lido (.xlsx).");
                }
            };

            reader.readAsArrayBuffer(file);
        }

        // =========================================================================

        function handleExcluirClick(e) { const oId = e.target.dataset.obraId; const o = database.obras.find(x => x.id === oId); if (!o) return; if (confirm(`Excluir "${o.nomeCompleto}"?\nA√ß√£o permanente.`)) { const idx = database.obras.findIndex(x => x.id === oId); if (idx > -1) { database.obras.splice(idx, 1); salvarDados(true); gerarNavegacao(database.obras); navList.querySelector('a[data-id="visao-geral"]').click(); } } }
        
        const modalObras = document.getElementById('modal-novo-contrato');
        const formObras = document.getElementById('form-novo-contrato');
        const btnAddObra = document.getElementById('btn-adicionar-contrato');
        modalObras.querySelectorAll('.close-button').forEach(b => b.addEventListener('click', () => fecharModal(modalObras, formObras)));
        modalObras.addEventListener('click', e => { if (e.target === modalObras) fecharModal(modalObras, formObras); });
        
        if (!isAdmin) { btnAddObra.style.display = 'none'; } else {
            btnAddObra.addEventListener('click', () => abrirModal(modalObras));
            formObras.addEventListener('submit', e => { e.preventDefault(); const nO = { id: `obra-${Date.now()}`, nomeCurto: formObras.querySelector('#nome-curto').value, nomeCompleto: formObras.querySelector('#nome-completo').value, dadosImobilizacao: { meta: parseFloat(formObras.querySelector('#meta-imob').value) || 0, atual: 0, historico: [] }, dadosCostAD: { meta: parseFloat(formObras.querySelector('#meta-costad').value) || 0, atual: 0, historico: [] }, dadosEconomia: { meta: parseInt(formObras.querySelector('#meta-econ').value, 10) || 0, atual: 0, historico: [] }, dadosAvanceFisico: { meta: parseInt(formObras.querySelector('#meta-avance').value, 10) || 0, atual: 0, historico: [] } }; database.obras.push(nO); salvarDados(true); gerarNavegacao(database.obras); fecharModal(modalObras, formObras); navList.querySelector('a[data-id="visao-geral"]').click(); });
        }

        const modalCS = document.getElementById('modal-comuniquese');
        const formCS = document.getElementById('form-comuniquese');
        modalCS.querySelectorAll('.close-button').forEach(b => b.addEventListener('click', () => fecharModal(modalCS, formCS)));
        modalCS.addEventListener('click', e => { if (e.target === modalCS) fecharModal(modalCS, formCS); });
        function abrirModalCS(id = null) { if (!isAdmin) return; formCS.reset(); const title = modalCS.querySelector('#modal-cs-title'); if (id) { const c = database.comuniqueses.find(x => x.id === id); if (!c) return; title.textContent = "Editar Comunique-se"; document.getElementById('cs-id').value = c.id; document.getElementById('cs-protocolo').value = c.protocolo; document.getElementById('cs-orgao').value = c.orgaoEmissor; document.getElementById('cs-data-recebimento').value = c.dataRecebimento; document.getElementById('cs-prazo-dias').value = c.prazoDias; document.getElementById('cs-assunto').value = c.assunto; document.getElementById('cs-responsavel').value = c.responsavel; document.getElementById('cs-status').value = c.status; document.getElementById('cs-data-resposta').value = c.dataResposta || ''; document.getElementById('cs-oficio-resposta').value = c.oficioResposta || ''; document.getElementById('cs-observacao').value = c.observacao || ''; } else { title.textContent = "Novo Comunique-se"; document.getElementById('cs-id').value = ''; } abrirModal(modalCS); }
        if (isAdmin) { formCS.addEventListener('submit', e => { e.preventDefault(); const id = document.getElementById('cs-id').value; const dR = new Date(document.getElementById('cs-data-recebimento').value + 'T00:00:00'); const pD = parseInt(document.getElementById('cs-prazo-dias').value, 10); dR.setDate(dR.getDate() + pD); const dL = dR.toISOString().split('T')[0]; const cD = { protocolo: document.getElementById('cs-protocolo').value, orgaoEmissor: document.getElementById('cs-orgao').value, dataRecebimento: document.getElementById('cs-data-recebimento').value, prazoDias: pD, dataLimite: dL, assunto: document.getElementById('cs-assunto').value, responsavel: document.getElementById('cs-responsavel').value, status: document.getElementById('cs-status').value, dataResposta: document.getElementById('cs-data-resposta').value || null, oficioResposta: document.getElementById('cs-oficio-resposta').value || '', observacao: document.getElementById('cs-observacao').value || '', }; if (id) { const idx = database.comuniqueses.findIndex(c => c.id === id); if (idx > -1) database.comuniqueses[idx] = { ...database.comuniqueses[idx], ...cD }; } else { cD.id = `com-${Date.now()}`; database.comuniqueses.push(cD); } salvarDados(true); fecharModal(modalCS, formCS); }); }
        
        function abrirModal(m) { m.classList.add('active'); } function fecharModal(m, f) { m.classList.remove('active'); if (f) f.reset(); }
        function enterFullScreenMode() { sidebar.classList.add('hidden'); contentArea.classList.add('fullscreen'); document.documentElement.requestFullscreen().catch(e => console.error(e)); }
        function exitFullScreenMode() { if (document.fullscreenElement) document.exitFullscreen(); sidebar.classList.remove('hidden'); contentArea.classList.remove('fullscreen'); }
        document.addEventListener('fullscreenchange', () => { if (!document.fullscreenElement) exitFullScreenMode(); });
        document.addEventListener('keydown', e => { if (e.key === 'Escape' && document.fullscreenElement) exitFullScreenMode(); });
        
        const toggleBtn = document.getElementById('sidebar-toggle-btn');
        const sidebarEl = document.querySelector('.sidebar');
        const overlayEl = document.getElementById('sidebar-overlay');
        function openSidebar() { sidebarEl.classList.add('is-open'); overlayEl.classList.add('is-open'); toggleBtn.setAttribute('aria-expanded', 'true'); }
        function closeSidebar() { sidebarEl.classList.remove('is-open'); overlayEl.classList.remove('is-open'); toggleBtn.setAttribute('aria-expanded', 'false'); }
        toggleBtn.addEventListener('click', () => { if (sidebarEl.classList.contains('is-open')) { closeSidebar(); } else { openSidebar(); } });
        overlayEl.addEventListener('click', closeSidebar);
        navList.addEventListener('click', (e) => { if (e.target.tagName === 'A' && window.innerWidth <= 992) { closeSidebar(); } });

        function calcularHistoricoAgregado(obras) { const agregados = { Imobiliza√ß√£o: {}, Economia: {}, Avan√ßo: {}, CostAD: {} }; const tipos = [ { key: 'dadosImobilizacao', nome: 'Imobiliza√ß√£o' }, { key: 'dadosEconomia', nome: 'Economia' }, { key: 'dadosAvanceFisico', nome: 'Avan√ßo' }, { key: 'dadosCostAD', nome: 'CostAD' } ]; for (const obra of obras) { for (const tipo of tipos) { const hist = obra[tipo.key]?.historico; if (hist && hist.length > 0) { for (const item of hist) { const { mes, meta, realizado } = item; if (!agregados[tipo.nome][mes]) { agregados[tipo.nome][mes] = { mes: mes, meta: 0, realizado: 0 }; } agregados[tipo.nome][mes].meta += meta || 0; agregados[tipo.nome][mes].realizado += realizado || 0; } } } } const obraEml2 = { id: 'coord-eml-2', nomeCurto: 'Coordena√ß√£o EML 2', nomeCompleto: 'Coordena√ß√£o EML 2', dadosImobilizacao: { historico: Object.values(agregados.Imobiliza√ß√£o) }, dadosEconomia: { historico: Object.values(agregados.Economia) }, dadosAvanceFisico: { historico: Object.values(agregados.Avan√ßo) }, dadosCostAD: { historico: Object.values(agregados.CostAD) } }; return obraEml2; }
        function mostrarMetasAcumuladas(obras) { contentArea.innerHTML = `<div class="content-header"><div><h1>Metas Acumuladas</h1><p>Hist√≥rico mensal de todos os contratos.</p></div><button id="btn-export-csv" class="btn-primary" style="background-color: #28a745;">üìä Exportar CSV</button></div><div class="dashboard-grid" id="container-metas-acumuladas"></div>`; const container = document.getElementById('container-metas-acumuladas'); if (!container) return; const obraEml2 = calcularHistoricoAgregado(obras); const todasAsObras = [obraEml2, ...obras]; const ordemDosCards = ["Coordena√ß√£o EML 2", "1B1", "1A2", "1B2", "1A1", "6A", "17B", "17A"]; const ordemMap = new Map(ordemDosCards.map((nome, index) => [nome, index])); const getSortIndex = (obra) => { if (obra.nomeCurto === "Coordena√ß√£o EML 2") return 0; const sufixo = obra.nomeCurto.split(' ').pop(); return ordemMap.has(sufixo) ? ordemMap.get(sufixo) : Infinity; }; const obrasOrdenadas = todasAsObras.sort((a, b) => { const indexA = getSortIndex(a); const indexB = getSortIndex(b); if (indexA === Infinity && indexB === Infinity) return a.nomeCurto.localeCompare(b.nomeCurto); return indexA - indexB; }); if (obrasOrdenadas.length === 0) { container.innerHTML = '<p>Nenhum contrato cadastrado.</p>'; return; } for (const obra of obrasOrdenadas) { const card = document.createElement('section'); card.className = 'metric-card progress-card'; const histImob = obra.dadosImobilizacao?.historico; const histEcon = obra.dadosEconomia?.historico; const histAvanc = obra.dadosAvanceFisico?.historico; const histCostAD = obra.dadosCostAD?.historico; card.innerHTML = `<h3>${obra.nomeCompleto || obra.nomeCurto}</h3><h4 style="margin-top: 15px; margin-bottom: 10px;">Hist√≥rico de Imobiliza√ß√£o (R$)</h4>${renderizarHistoricoTabela(histImob, 'currency')}<h4 style="margin-top: 20px; margin-bottom: 10px;">Hist√≥rico CostAD (R$)</h4>${renderizarHistoricoTabela(histCostAD, 'currency')}<h4 style="margin-top: 20px; margin-bottom: 10px;">Hist√≥rico de Economias (Un.)</h4>${renderizarHistoricoTabela(histEcon, 'units')}<h4 style="margin-top: 20px; margin-bottom: 10px;">Hist√≥rico de Avan√ßo F√≠sico (m)</h4>${renderizarHistoricoTabela(histAvanc, 'units')}`; container.appendChild(card); } document.getElementById('btn-export-csv').addEventListener('click', () => exportarParaCSV(obrasOrdenadas)); }
        function renderizarHistoricoTabela(historico, tipoValor) { if (!historico || historico.length === 0) { return '<p style="font-size: 0.9rem; color: #6c757d; margin: 0;">Nenhum hist√≥rico lan√ßado para este item.</p>'; } const formatFn = (tipoValor === 'currency') ? formatCurrency : formatUnits; const historicoOrdenado = [...historico].sort((a, b) => a.mes.localeCompare(b.mes)); let totalMeta = 0; let totalRealizado = 0; let tabelaHtml = `<div class="cs-table-wrapper" style="max-height: 300px; overflow-y: auto;"><table class="cs-table" style="min-width: 0; white-space: nowrap;"><thead><tr><th>M√™s/Ano</th><th>Meta</th><th>Realizado</th><th>Diferen√ßa</th></tr></thead><tbody>`; for (const item of historicoOrdenado) { const meta = item.meta || 0; const realizado = item.realizado || 0; const diff = realizado - meta; totalMeta += meta; totalRealizado += realizado; let diffClass = ''; if (diff > 0) diffClass = 'goal-surpassed'; if (diff < 0) diffClass = 'prazo-vencido'; tabelaHtml += `<tr><td>${item.mes.replace('-', '/')}</td><td>${formatFn(meta)}</td><td>${formatFn(realizado)}</td><td style="font-weight: 600;" class="${diffClass}">${formatFn(diff)}</td></tr>`; } const totalDiff = totalRealizado - totalMeta; let diffClassTotal = ''; if (totalDiff > 0) diffClassTotal = 'goal-surpassed'; if (totalDiff < 0) diffClassTotal = 'prazo-vencido'; tabelaHtml += `<tr style="background-color: #f8faff; border-top: 2px solid #dbe3f0;"><td style="font-weight: 700;">Total</td><td style="font-weight: 700;">${formatFn(totalMeta)}</td><td style="font-weight: 700;">${formatFn(totalRealizado)}</td><td style="font-weight: 700;" class="${diffClassTotal}">${formatFn(totalDiff)}</td></tr>`; tabelaHtml += `</tbody></table></div>`; return tabelaHtml; }
        function exportarParaCSV(obrasOrdenadas) { console.log("Iniciando exporta√ß√£o CSV..."); const allMonths = new Set(); const dataMatrix = {}; const tipos = [ { key: 'dadosImobilizacao', nome: 'Imobiliza√ß√£o' }, { key: 'dadosEconomia', nome: 'Economia' }, { key: 'dadosAvanceFisico', nome: 'Avan√ßo F√≠sico' }, { key: 'dadosCostAD', nome: 'CostAD' } ]; const metricas = [ "Imobiliza√ß√£o Projetada", "Imobiliza√ß√£o Realizada", "Economia Projetada", "Economia Realizada", "Avan√ßo F√≠sico Projetado", "Avan√ßo F√≠sico Realizado", "CostAD Projetado", "CostAD Realizado" ]; for (const obra of obrasOrdenadas) { const obraName = obra.nomeCurto; dataMatrix[obraName] = {}; for (const metrica of metricas) { dataMatrix[obraName][metrica] = {}; } for (const tipo of tipos) { const hist = obra[tipo.key]?.historico; if (hist) { for (const item of hist) { allMonths.add(item.mes); dataMatrix[obraName][tipo.nome + ' Projetada'][item.mes] = item.meta || 0; dataMatrix[obraName][tipo.nome + ' Realizada'][item.mes] = item.realizado || 0; } } } } const sortedMonths = Array.from(allMonths).sort(); const monthNames = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"]; const headerMeses = sortedMonths.map(mes => { const [year, month] = mes.split('-'); return `${monthNames[parseInt(month, 10) - 1]}/${year}`; }); const header = ["Contrato", "M√©trica", ...headerMeses]; let csvContent = []; csvContent.push(header.join(';')); for (const obra of obrasOrdenadas) { const obraName = obra.nomeCurto; for (const metrica of metricas) { let row = [obraName, metrica]; for (const month of sortedMonths) { const valor = dataMatrix[obraName][metrica][month] || 0; row.push(valor); } csvContent.push(row.join(';')); } csvContent.push(''); } const csvString = '\uFEFF' + csvContent.join('\n'); const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); if (link.download !== undefined) { const url = URL.createObjectURL(blob); link.setAttribute("href", url); link.setAttribute("download", "relatorio_metas_acumuladas.csv"); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); } }
        function gerarTextoHistorico(obras) { let output = []; const tipos = [ { key: 'dadosImobilizacao', nome: 'Imobiliza√ß√£o' }, { key: 'dadosCostAD', nome: 'CostAD' }, { key: 'dadosEconomia', nome: 'Economia' }, { key: 'dadosAvanceFisico', nome: 'Avan√ßo' } ]; const ordemDosCards = ["1B1", "1A2", "1B2", "1A1", "6A", "17B", "17A"]; const ordemMap = new Map(ordemDosCards.map((nome, index) => [nome, index])); const getSortIndex = (obra) => { const sufixo = obra.nomeCurto.split(' ').pop(); return ordemMap.has(sufixo) ? ordemMap.get(sufixo) : Infinity; }; const obrasOrdenadas = [...obras].sort((a, b) => { const indexA = getSortIndex(a); const indexB = getSortIndex(b); if (indexA === Infinity && indexB === Infinity) { return a.nomeCurto.localeCompare(b.nomeCurto); } return indexA - indexB; }); for (const obra of obrasOrdenadas) { output.push(`\n# ${obra.nomeCurto}`); let hasEntries = false; for (const tipo of tipos) { const dados = obra[tipo.key]; if (dados && dados.historico && dados.historico.length > 0) { dados.historico.sort((a,b) => a.mes.localeCompare(b.mes)); for (const item of dados.historico) { output.push(`${tipo.nome}, ${item.mes}, ${item.meta || 0}, ${item.realizado || 0}`); hasEntries = true; } } } if (!hasEntries) output.push(`(Nenhum hist√≥rico lan√ßado)`); } return output.join('\n').trim(); }
        function handleSalvarHistorico() { const text = document.getElementById('historico-textarea').value; const lines = text.split('\n'); let currentObra = null; if (!confirm("Tem certeza que deseja salvar? Isso ir√° sobrescrever o hist√≥rico existente.")) { return; } for (const obra of database.obras) { if (obra.dadosImobilizacao) obra.dadosImobilizacao.historico = []; if (obra.dadosEconomia) obra.dadosEconomia.historico = []; if (obra.dadosAvanceFisico) obra.dadosAvanceFisico.historico = []; if (!obra.dadosCostAD) obra.dadosCostAD = {}; obra.dadosCostAD.historico = []; } for (const line of lines) { const trimmedLine = line.trim(); if (trimmedLine.startsWith('#')) { const nomeCurto = trimmedLine.substring(1).trim(); currentObra = database.obras.find(o => o.nomeCurto === nomeCurto); if (!currentObra) console.warn(`Obra n√£o encontrada: ${nomeCurto}`); continue; } if (!currentObra || trimmedLine === "" || trimmedLine.startsWith('(')) { continue; } const parts = trimmedLine.split(',').map(s => s.trim()); if (parts.length !== 4) { console.warn(`Linha mal formatada: ${trimmedLine}`); continue; } const [tipo, mes, metaStr, realizadoStr] = parts; const meta = parseFloat(metaStr) || 0; const realizado = parseFloat(realizadoStr) || 0; if (!/^\d{4}-\d{2}$/.test(mes)) { console.warn(`Formato de m√™s inv√°lido: ${mes}. Use YYYY-MM.`); continue; } const newItem = { mes, meta, realizado }; let targetArray = null; if (tipo.toLowerCase().startsWith('imobil')) { if (!currentObra.dadosImobilizacao) currentObra.dadosImobilizacao = {}; if (!currentObra.dadosImobilizacao.historico) currentObra.dadosImobilizacao.historico = []; targetArray = currentObra.dadosImobilizacao.historico; } else if (tipo.toLowerCase().startsWith('econ')) { if (!currentObra.dadosEconomia) currentObra.dadosEconomia = {}; if (!currentObra.dadosEconomia.historico) currentObra.dadosEconomia.historico = []; targetArray = currentObra.dadosEconomia.historico; } else if (tipo.toLowerCase().startsWith('avan')) { if (!currentObra.dadosAvanceFisico) currentObra.dadosAvanceFisico = {}; if (!currentObra.dadosAvanceFisico.historico) currentObra.dadosAvanceFisico.historico = []; targetArray = currentObra.dadosAvanceFisico.historico; } else if (tipo.toLowerCase().startsWith('cost')) { if (!currentObra.dadosCostAD) currentObra.dadosCostAD = {}; if (!currentObra.dadosCostAD.historico) currentObra.dadosCostAD.historico = []; targetArray = currentObra.dadosCostAD.historico; } else { console.warn(`Tipo desconhecido: ${tipo}`); continue; } targetArray.push(newItem); } console.log("Database atualizado com hist√≥rico:", database); alert("Hist√≥rico processado. Salvando no banco..."); salvarDados(true); }
        function mostrarPaginaHistorico() { if (!isAdmin) { contentArea.innerHTML = `<div class="content-header"><h1>Acesso Negado</h1><p>Esta √°rea √© restrita.</p></div>`; return; } let currentText = gerarTextoHistorico(database.obras); contentArea.innerHTML = `<div class="content-header"><div><h1>Lan√ßar Hist√≥rico Mensal</h1><p>Use o formato abaixo. O salvamento <strong>sobrescreve todo</strong> o hist√≥rico anterior.</p></div></div><div class="metric-card"><h3>Instru√ß√µes</h3><ul style="font-size: 0.9rem;"><li>Linhas com <code># Nome do Contrato</code> definem qual contrato os dados abaixo pertencem. (Ex: <code># Pacote 17A</code>)</li><li>Linhas de dados devem ter o formato: <code>TIPO, YYYY-MM, META, REALIZADO</code></li><li><strong>Tipos v√°lidos:</strong> <code>Imobiliza√ß√£o</code>, <code>Economia</code>, <code>Avan√ßo</code>, <code>CostAD</code>.</li><li><strong>Exemplo:</strong> <code>CostAD, 2025-03, 10000, 12000</code></li></ul><textarea id="historico-textarea" style="width: 100%; height: 50vh; font-family: 'Courier New', Courier, monospace; font-size: 14px; padding: 10px; border: 1px solid #ccc; border-radius: 8px;">${currentText}</textarea><div style="text-align: right; margin-top: 20px;"><button id="btn-salvar-historico" class="btn-primary" style="background-color: #c82333;">Salvar e Sobrescrever Hist√≥rico</button></div></div>`; document.getElementById('btn-salvar-historico').addEventListener('click', handleSalvarHistorico); }
        
        // ==========================================
        // M√ìDULO DE CORRE√á√ÉO AUTOM√ÅTICA DE METAS (v20)
        // ==========================================
        function aplicarCorrecaoMetas2025_2026() {
            // Dados fornecidos pelo usu√°rio para corre√ß√£o (r25 = Realizado 2025, m26 = Meta 2026 Restante)
            const DATA_CORRECTION = [
                { key: '1B1', r25: 7565, m26: 16508 },
                { key: '1A2', r25: 16175, m26: 23000 },
                { key: '1B2', r25: 11750, m26: 17759 },
                { key: '1A1', r25: 5581, m26: 19273 },
                { key: '6A',  r25: 17076, m26: 26047 },
                { key: '17B', r25: 2076, m26: 3327 },
                { key: '17A', r25: 700, m26: 1885 }
            ];

            let mudou = false;

            DATA_CORRECTION.forEach(d => {
                // Tenta encontrar a obra pelo nome (ex: "Pacote 1B1" cont√©m "1B1")
                const obra = database.obras.find(o => o.nomeCurto.toUpperCase().includes(d.key));
                
                if (obra) {
                    // Meta Global = Realizado 2025 + O que falta em 2026
                    const novaMetaGlobal = d.r25 + d.m26;

                    // Se a meta ou o realizado armazenado estiverem diferentes, atualiza
                    if (obra.dadosEconomia.meta !== novaMetaGlobal || obra.dadosEconomia.realizado2025 !== d.r25) {
                        console.log(`Corrigindo dados para ${obra.nomeCurto}: MetaGlobal ${novaMetaGlobal}, Realizado25 ${d.r25}`);
                        obra.dadosEconomia.meta = novaMetaGlobal;
                        obra.dadosEconomia.realizado2025 = d.r25; // Salva o realizado de 2025 no objeto
                        mudou = true;
                    }
                }
            });

            // Se houve altera√ß√£o, salva no servidor
            if (mudou && isAdmin) {
                console.log("Corre√ß√µes aplicadas. Salvando dados...");
                salvarDados();
            }
        }

        async function carregarDados() { 
            try { 
                const r = await fetch(JSONBIN_URL, { headers: { 'X-Master-Key': API_KEY } }); 
                if (!r.ok) throw new Error(`Falha na rede: ${r.status}`); 
                const d = await r.json(); 
                database = d.record; 
                if (!database.obras) database.obras = []; 
                if (!database.comuniqueses) database.comuniqueses = []; 
                database.obras.forEach(o => { if (!o.dadosCostAD) o.dadosCostAD = { meta: 0, atual: 0, historico: [] }; }); 
                
                // APLICA A CORRE√á√ÉO LOGO AP√ìS CARREGAR
                aplicarCorrecaoMetas2025_2026();

                gerarNavegacao(database.obras); 
                const linkAtivo = navList.querySelector('a.active'); 
                if (linkAtivo) { linkAtivo.click(); } else { mostrarPainelTV(); } 
            } catch (e) { 
                console.error("Erro fatal:", e); 
                contentArea.innerHTML = `<div class="content-header"><div><h1>Erro ao Carregar Dados</h1><p>N√£o foi poss√≠vel conectar. Verifique URL/Chave e conex√£o. Detalhes: ${e.message}</p></div></div>`; 
            } 
        }

        let saveTimeout;
        function salvarDados(fU = false) { if (!isAdmin) { console.warn("Modo de leitura. Salvamento bloqueado."); return; } clearTimeout(saveTimeout); saveTimeout = setTimeout(async () => { console.log("Salvando..."); try { const r = await fetch(JSONBIN_URL, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY }, body: JSON.stringify(database) }); if (!r.ok) throw new Error('Falha ao salvar.'); console.log("Salvo!"); if (fU) { const aL = navList.querySelector('a.active'); if (aL) aL.click(); } } catch (e) { console.error("Erro ao salvar:", e); alert("N√£o foi poss√≠vel salvar."); } }, 1500); }
        function handleNavClick(e) { 
            e.preventDefault(); 
            // Agora handlePainelTVKeyPress existe e √© acess√≠vel
            document.removeEventListener('keydown', handlePainelTVKeyPress); 
            clearInterval(slideshowInterval); 
            const id = e.target.dataset.id; 
            const cA = navList.querySelector('a.active'); 
            if (cA) cA.classList.remove('active'); 
            e.target.classList.add('active'); 
            if (document.fullscreenElement) document.exitFullscreen(); 
            sidebar.classList.remove('hidden'); 
            contentArea.classList.remove('fullscreen'); 
            if (id === 'visao-geral') mostrarVisaoGeral(database.obras); 
            else if (id === 'painel-tv') mostrarPainelTV(); 
            else if (id === 'comuniqueses') mostrarPaginaComuniqueses(); 
            else if (id === 'planejamento-2026') window.mostrarPlanejamento2026(); 
            else if (id === 'metas-acumuladas') mostrarMetasAcumuladas(database.obras); 
            else if (id === 'lancar-historico') mostrarPaginaHistorico(); 
            else { const o = database.obras.find(x => x.id === id); if (o) mostrarPaginaObra(o); } 
        }
        function handleInputChange(e) { const i = e.target, oId = i.dataset.obraId, t = i.dataset.tipo; let vN = parseFloat(i.value.replace(/\./g, '').replace(',', '.')) || 0; const o = database.obras.find(x => x.id === oId); if (!o) return; switch (t) { case 'imobilizacao': o.dadosImobilizacao.atual = vN; break; case 'costad': if(!o.dadosCostAD) o.dadosCostAD = {}; o.dadosCostAD.atual = vN; break; case 'economia': o.dadosEconomia.atual = Math.round(vN); break; case 'avance': o.dadosAvanceFisico.atual = Math.round(vN); break; } salvarDados(); }

        carregarDados();
    });
    </script>
</body>
</html>

